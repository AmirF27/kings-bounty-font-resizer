name: PR Auto Triage

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]

permissions:
  pull-requests: write
  issues: write

jobs:
  auto_triage:
    runs-on: ubuntu-latest
    steps:
      - name: Assign PR (prefer issue assignee, fallback to PR author)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return;

            // Only on open to avoid fighting manual changes
            if (context.payload.action !== "opened") return;

            const branch = pr.head.ref;
            const match = branch.match(/(?:^|\/)(\d+)(?:-|$)/);
            let assignees = [];

            if (match) {
              const issueNumber = Number(match[1]);

              try {
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                });

                if (issue.assignees && issue.assignees.length > 0) {
                  assignees = issue.assignees.map(a => a.login);
                }
              } catch (e) {
                core.info(`Could not fetch issue #${match[1]} to sync assignees; falling back to PR author.`);
              }
            }

            if (assignees.length === 0) {
              assignees = [pr.user.login];
            }

            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              assignees,
            });

            core.info(`Assigned PR #${pr.number} to: ${assignees.join(", ")}`);

      - name: Sync milestone from issue referenced in branch name (e.g. feat/50-*)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return;

            const branch = pr.head.ref; // e.g. "feat/50-some-feature"
            const match = branch.match(/(?:^|\/)(\d+)(?:-|$)/);
            if (!match) {
              core.info(`No issue number found in branch name: ${branch}`);
              return;
            }

            const issueNumber = Number(match[1]);
            core.info(`Detected issue number: ${issueNumber}`);

            // Fetch the issue to see which milestone it has
            let issue;
            try {
              const res = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
              });
              issue = res.data;
            } catch (e) {
              core.warning(`Could not fetch issue #${issueNumber}. Does it exist in this repo?`);
              return;
            }

            if (!issue.milestone) {
              core.info(`Issue #${issueNumber} has no milestone. Nothing to sync.`);
              return;
            }

            const milestoneNumber = issue.milestone.number;
            core.info(`Syncing milestone #${milestoneNumber} (${issue.milestone.title}) to PR #${pr.number}`);

            // Set milestone on the PR (PRs are "issues" in GitHub API)
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              milestone: milestoneNumber,
            });

      - name: Auto-set PR title from branch type + issue title
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return;

            if (context.payload.action !== "opened") return;

            const branch = pr.head.ref; // e.g. "feat/47-parse-and-resize-string-based"

            function normalize(s) {
              return s
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, " ")
                .trim()
                .replace(/\s+/g, " ");
            }

            const branchSuffix = branch.includes("/") ? branch.split("/").pop() : branch;

            const titleNorm = normalize(pr.title);
            const branchNorm = normalize(branch);
            const suffixNorm = normalize(branchSuffix);

            core.info(`PR title: "${pr.title}"`);
            core.info(`Branch: "${branch}"`);
            core.info(`Normalized title: "${titleNorm}"`);
            core.info(`Normalized branch: "${branchNorm}"`);
            core.info(`Normalized suffix: "${suffixNorm}"`);

            const isDefaultish = titleNorm === branchNorm || titleNorm === suffixNorm;

            if (!isDefaultish) {
              core.info("Title does not look auto-generated; not overwriting.");
              return;
            }

            // Extract issue number from branch
            const issueMatch = branch.match(/(?:^|\/)(\d+)(?:-|$)/);
            if (!issueMatch) {
              core.warning(`No issue number found in branch name: ${branch}`);
              return;
            }
            const issueNumber = Number(issueMatch[1]);

            // Type from prefix (before slash)
            const typeMatch = branch.match(/^([a-zA-Z]+)\//);
            const type = (typeMatch?.[1] || "chore").toLowerCase();

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            const issueTitle = issue.title || "";
            const decap = issueTitle.length ? issueTitle[0].toLowerCase() + issueTitle.slice(1) : issueTitle;

            const newTitle = `${type}: ${decap} (#${issueNumber})`;
            core.info(`Updating PR title to: "${newTitle}"`);

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              title: newTitle,
            });

      - name: Sync labels from linked issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return;

            // Only run when PR is opened
            if (context.payload.action !== "opened") return;

            const branch = pr.head.ref;
            const match = branch.match(/(?:^|\/)(\d+)(?:-|$)/);
            if (!match) {
              core.info(`No issue number found in branch name: ${branch}`);
              return;
            }

            const issueNumber = Number(match[1]);

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            if (!issue.labels || issue.labels.length === 0) {
              core.info(`Issue #${issueNumber} has no labels.`);
              return;
            }

            const labels = issue.labels
              .map(l => typeof l === "string" ? l : l.name)
              .filter(name => name.startsWith("type:"));

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels,
            });

            core.info(`Synced labels from issue #${issueNumber}: ${labels.join(", ")}`);
